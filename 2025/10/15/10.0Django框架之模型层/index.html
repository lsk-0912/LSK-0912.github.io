<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"aurora-lsk.asia","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Django框架之模型层 【一】模型层引入（测试环境搭建）  Django的orm框架必须是在Django的启动状态下才能使用 Django为我们提供了测试环境 这个测试环境只是临时启动而不是持久化活动  创建测试环境 &#96;&#96;&#96;python import os  if __name__ &#x3D;&#x3D; &#39;__main__&#39;:     # 在main入口下面复制manage.py文件中main入口下面的第一行代">
<meta property="og:type" content="article">
<meta property="og:title" content="10.0Django框架之模型层">
<meta property="og:url" content="https://aurora-lsk.asia/2025/10/15/10.0Django%E6%A1%86%E6%9E%B6%E4%B9%8B%E6%A8%A1%E5%9E%8B%E5%B1%82/index.html">
<meta property="og:site_name" content="Aurora博客">
<meta property="og:description" content="Django框架之模型层 【一】模型层引入（测试环境搭建）  Django的orm框架必须是在Django的启动状态下才能使用 Django为我们提供了测试环境 这个测试环境只是临时启动而不是持久化活动  创建测试环境 &#96;&#96;&#96;python import os  if __name__ &#x3D;&#x3D; &#39;__main__&#39;:     # 在main入口下面复制manage.py文件中main入口下面的第一行代">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-15T03:34:55.000Z">
<meta property="article:modified_time" content="2025-10-15T08:41:49.779Z">
<meta property="article:author" content="Aurora">
<meta property="article:tag" content="Blog">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://aurora-lsk.asia/2025/10/15/10.0Django%E6%A1%86%E6%9E%B6%E4%B9%8B%E6%A8%A1%E5%9E%8B%E5%B1%82/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>10.0Django框架之模型层 | Aurora博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Aurora博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://aurora-lsk.asia/2025/10/15/10.0Django%E6%A1%86%E6%9E%B6%E4%B9%8B%E6%A8%A1%E5%9E%8B%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Aurora">
      <meta itemprop="description" content="选择有时候比努力更重要，但是你不努力，选择就只是空谈">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aurora博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          10.0Django框架之模型层
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-10-15 11:34:55 / 修改时间：16:41:49" itemprop="dateCreated datePublished" datetime="2025-10-15T11:34:55+08:00">2025-10-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1>Django框架之模型层</h1>
<h2 id="【一】模型层引入（测试环境搭建）">【一】模型层引入（测试环境搭建）</h2>
<ul>
<li>Django的orm框架必须是在Django的启动状态下才能使用</li>
<li>Django为我们提供了测试环境</li>
<li>这个测试环境只是临时启动而不是持久化活动</li>
</ul>
<p>创建测试环境</p>
```python
import os

if __name__ == '__main__':
    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'Django_two.settings')
    # 导入模块
    import django
    # 启动方式只是临时启动，不是持久化
    django.setup()
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 【二】Django的ORM的单表操作</span><br><span class="line"></span><br><span class="line">### 【1】数据库配置</span><br><span class="line"></span><br><span class="line">- 在setting.py文件中配置</span><br><span class="line">  - 将原来django自带的删掉</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    &#x27;default&#x27;: &#123;</span><br><span class="line">        &#x27;ENGINE&#x27;: &#x27;django.db.backends.mysql&#x27;,</span><br><span class="line">        # 手动创建一个新的数据库</span><br><span class="line">        &#x27;NAME&#x27;: &quot;django_two&quot;,</span><br><span class="line">        &quot;USER&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;PASSWORD&quot;: &quot;1234567&quot;,</span><br><span class="line">        &quot;HOST&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;PORT&quot;: 3306,</span><br><span class="line">        &quot;CHARSET&quot;: &quot;utf8mb4&quot;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动项目可能会报错</li>
<li>原因是没有下载mysqlclient</li>
</ul>
<p>解决方法一</p>
<ul>
<li>
<p>打猴子补丁</p>
</li>
<li>
<p>随便找一个文件，一般都会选择<code>__init__.py</code>文件</p>
</li>
<li>
<p>把下面的数据复制进去即可</p>
</li>
</ul>
```python
import pymysql

pymysql.install_as_MySQLdb()
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line"></span><br><span class="line">- 下载mysqlclient</span><br><span class="line"></span><br><span class="line">### 【2】在APP下的models.py文件中定义模型表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserInfo(models.Model):</span><br><span class="line">    # 名字</span><br><span class="line">    name = models.CharField(max_length=32, verbose_name=&quot;名字&quot;)</span><br><span class="line">    # 年龄</span><br><span class="line">    age = models.IntegerField(verbose_name=&quot;年龄&quot;)</span><br><span class="line">    # 显示注册时间</span><br><span class="line">    # auto_now_add=True</span><br><span class="line">    # Django会在对象第一次被创建时自动设置该字段的值为当前的日期和时间。之后，无论对象如何被保存或修改，这个字段的值都不会再自动更新</span><br><span class="line">    # DateTimeField类型</span><br><span class="line">    # 用于在数据库中存储日期和时间</span><br><span class="line">    register_time = models.DateTimeField(auto_now_add=True,</span><br><span class="line">                                         verbose_name=&quot;注册时间&quot;)</span><br><span class="line">    # auto_now：在创建数据库的时候会自动新增时间，每次修改都会刷新</span><br><span class="line">    update_time = models.DateTimeField(auto_now=True,</span><br><span class="line">                                       verbose_name=&quot;更新时间&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>
<p>迁移数据库</p>
<ul>
<li>执行两句话</li>
</ul>
```shell
  python manage.py makemigrations
  
  python manage.py migrate
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  - 执行完后就迁移成功了</span><br><span class="line"></span><br><span class="line">  ![image-20240625202154249](D:\pycharm\Temporary_notes\图片\image-20240625202154249.png)</span><br><span class="line"></span><br><span class="line">### 【3】对数据库的增删改查（必会N条）</span><br><span class="line"></span><br><span class="line">- 在你的测试环境下面写</span><br><span class="line"></span><br><span class="line">#### （1）增</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制</span><br><span class="line">    os.environ.setdefault(&#x27;DJANGO_SETTINGS_MODULE&#x27;, &#x27;Django_two.settings&#x27;)</span><br><span class="line">    # 导入模块</span><br><span class="line">    import django</span><br><span class="line"></span><br><span class="line">    # 启动方式只是临时启动，不是持久化</span><br><span class="line">    django.setup()</span><br><span class="line"></span><br><span class="line">    from user.models import UserInfo</span><br><span class="line"></span><br><span class="line">    # 记住在django中pk就是mysql中的id</span><br><span class="line">    # 【1】对数据库增值</span><br><span class="line">    # 方式一 create()</span><br><span class="line">    # data = UserInfo.objects.create(name=&quot;jack&quot;, age=22)</span><br><span class="line">    # print(data) # UserInfo object (1)</span><br><span class="line">    # 方法二 先生成一个对象，然后在提交事务</span><br><span class="line">    # data = UserInfo(name=&quot;tom&quot;, age=710)</span><br><span class="line">    # print(data) # UserInfo object (None)</span><br><span class="line">    # 提交事务，不提交事务不会添加数据</span><br><span class="line">    # data.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="（2）删">（2）删</h4>
```python
 import os

if __name__ == '__main__':
    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'Django_two.settings')
    # 导入模块
    import django

    # 启动方式只是临时启动，不是持久化
    django.setup()

    from user.models import UserInfo

    # 记住在django中pk就是mysql中的id
    
    # 【4】删除数据
    # 方法一 获取到筛选的结果，然后对结果进行删除.delete()
    # 会把符合条件的全部删除
    # data = UserInfo.objects.filter(name="tom").delete()
    # print(data) # (2, {'user.UserInfo': 2})# 删除了两条数据
    # 方法二 直接删除对象
    # data = UserInfo.objects.get(name="dream").delete()
    # print(data)  # (1, {'user.UserInfo': 1}) #删除了一条数据
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （3）改</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制</span><br><span class="line">    os.environ.setdefault(&#x27;DJANGO_SETTINGS_MODULE&#x27;, &#x27;Django_two.settings&#x27;)</span><br><span class="line">    # 导入模块</span><br><span class="line">    import django</span><br><span class="line"></span><br><span class="line">    # 启动方式只是临时启动，不是持久化</span><br><span class="line">    django.setup()</span><br><span class="line"></span><br><span class="line">    from user.models import UserInfo</span><br><span class="line"></span><br><span class="line">    # 记住在django中pk就是mysql中的id</span><br><span class="line"></span><br><span class="line"># 【3】对数据库修改数据</span><br><span class="line">    # 方法一 查完后直接修改</span><br><span class="line">    # data = UserInfo.objects.filter(name=&quot;jack&quot;).update(name=&quot;dream&quot;)</span><br><span class="line">    # print(data) # 2 # 代表修改了两条数据</span><br><span class="line">    # 方法二 先查对象，然后对象.属性名改值</span><br><span class="line">    # data = UserInfo.objects.get(pk=1)</span><br><span class="line">    # data.name = &quot;tom&quot;</span><br><span class="line">    # print(data)  # UserInfo object (1)</span><br><span class="line">    # # 一定要提交数据</span><br><span class="line">    # data.save()</span><br><span class="line">    # # 修改成功</span><br></pre></td></tr></table></figure>

<h4 id="（4）查">（4）查</h4>
```python
import os

if __name__ == '__main__':
    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'Django_two.settings')
    # 导入模块
    import django

    # 启动方式只是临时启动，不是持久化
    django.setup()

    from user.models import UserInfo

    # 记住在django中pk就是mysql中的id

# 【2】查询数据库里面的数据
    # 方式一 get和values取出所有符合条件的值，all取出所有的数据对象
    # data = UserInfo.objects.all()
    # # 得到的是所有数据的对象
    # print(data) # <QuerySet [<UserInfo: UserInfo object (1)>, <UserInfo: UserInfo object (2)>, <UserInfo: UserInfo object (3)>]>
    # data = UserInfo.objects.all().values("name")
    # # 取出所有人的名字
    # print(data)
    # # <QuerySet [{'name': 'jack'}, {'name': 'jack'}, {'name': 'tom'}]>
    # # 得到id为1的user对象
    # data = UserInfo.objects.get(pk=1)
    # print(data)
    # # UserInfo object (1)
    # # 得到数据
    # data = data.name
    # print(data)  # jack
    # 方法二 fileter过滤结果 结果是queryset对象
    # data = UserInfo.objects.filter(pk=1)
    # print(data)  # <QuerySet [<UserInfo: UserInfo object (1)>]>
    # 获得结果集的第一个结果
    # 因为就一个结果，都可以获得
    # data = data.first()
    # print(data) # UserInfo object (1)
    # 获得结果集的最后一个结果
    # 因为就一个结果，都可以获得
    # data = data.last()
    # print(data)  # UserInfo object (1)
    # 获得结果集中的所有符合条件的结果
    # data = UserInfo.objects.filter(name="jack")
    # print(data) # <QuerySet [<UserInfo: UserInfo object (1)>, <UserInfo: UserInfo object (2)>]>
    # data = data.all()
    # print(data) # <QuerySet [<UserInfo: UserInfo object (1)>, <UserInfo: UserInfo object (2)>]>
    # 获取结果集中的对应字段对应的数据,values得到的是字典
    # data = UserInfo.objects.filter(age=22).values("name", "age")
    # print(data)
    # <QuerySet [{'name': 'jack', 'age': 22}, {'name': 'jack', 'age': 22}]>
    # 获取结果集中的对应字段对应的数据,values_list得到的是字典
    # data = UserInfo.objects.filter(age=22).values_list("name", "age")
    # print(data) # <QuerySet [('jack', 22), ('jack', 22)]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （5）其它方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制</span><br><span class="line">    os.environ.setdefault(&#x27;DJANGO_SETTINGS_MODULE&#x27;, &#x27;Django_two.settings&#x27;)</span><br><span class="line">    # 导入模块</span><br><span class="line">    import django</span><br><span class="line"></span><br><span class="line">    # 启动方式只是临时启动，不是持久化</span><br><span class="line">    django.setup()</span><br><span class="line"></span><br><span class="line">    from user.models import UserInfo</span><br><span class="line"></span><br><span class="line">    # 记住在django中pk就是mysql中的id</span><br><span class="line"></span><br><span class="line"># 【5】去重</span><br><span class="line">	# 筛选数的第一条数据</span><br><span class="line">    # user = UserInfo.objects.values(&quot;age&quot;).distinct().first()</span><br><span class="line">    # print(user, type(user))</span><br><span class="line">    # &#123;&#x27;age&#x27;: 18&#125; &lt;class &#x27;dict&#x27;&gt;</span><br><span class="line"></span><br><span class="line">    # 【6】知道数据的结果量</span><br><span class="line">    # user = UserInfo.objects.count()</span><br><span class="line">    # print(user)</span><br><span class="line"></span><br><span class="line">    # 【7】排序</span><br><span class="line">    # 正序排 MySQL正序加 asc</span><br><span class="line">    # user = UserInfo.objects.order_by(&quot;age&quot;)</span><br><span class="line">    # print(user)</span><br><span class="line">    # 倒序排 MySQL倒序加 desc</span><br><span class="line">    # user = UserInfo.objects.order_by(&quot;-age&quot;)</span><br><span class="line">    # print(user)</span><br><span class="line">    # 将排序后的结果翻转</span><br><span class="line">    # user = UserInfo.objects.order_by(&quot;age&quot;).reverse()</span><br><span class="line">    # print(user)</span><br><span class="line">    # 在Django的ORM语句中只要不是确切的某个对象 就可以一直 . 触发其他方法</span><br><span class="line">    # user = UserInfo.objects.order_by(&quot;age&quot;).count()</span><br><span class="line">    # print(user)</span><br><span class="line"></span><br><span class="line">    # 【8】对某个条件以外的结果进行剔除</span><br><span class="line">    # 不会提出到你指定的这个年龄的结果</span><br><span class="line">    # user = UserInfo.objects.exclude(age=18)</span><br><span class="line">    # print(user)</span><br><span class="line"></span><br><span class="line">    # 【9】判断当前筛选到的结果是否存在</span><br><span class="line">    # user = UserInfo.objects.filter(name=&quot;dream_1&quot;).exists()</span><br><span class="line">    # print(user)</span><br><span class="line">``````</span><br><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line"># 【必知必会N条】</span><br><span class="line">	# model是models.py文件中定义模型表的类名，需要提前导入</span><br><span class="line">    # 【1】增加</span><br><span class="line">    # （1）model.objects.create(filed=value)</span><br><span class="line">    # （2）model(filed=value).save()</span><br><span class="line">    # 【2】删除</span><br><span class="line">    # （3）model.objects.filter(filed=value).delete()</span><br><span class="line">    # （4）model.objects.get(filed=value).delete()</span><br><span class="line">    # 【3】修改</span><br><span class="line">    # （5）model.objects.filter(filed=value).update(filed=new_value)</span><br><span class="line">    # （6）obj = model.objects.get(filed=value)</span><br><span class="line">    # obj.filed_name = value </span><br><span class="line">    # obj.save()</span><br><span class="line">    # 【4】查看</span><br><span class="line">    # (7) model.objects.filter(field=value)</span><br><span class="line">    # (8) model.objects.filter(field=value).first()</span><br><span class="line">    # (9) model.objects.filter(field=value).last()</span><br><span class="line">    # (10) model.objects.all() </span><br><span class="line">    # (11) model.objects.get(filed=value)</span><br><span class="line">    # 【5】扩展方法</span><br><span class="line">    # (12) model.objects.filter(field=value).count() 计数</span><br><span class="line">    # (13) model.objects.filter(field=value).values() 获取键值对结果</span><br><span class="line">    # (14) model.objects.filter(field=value).values_list() 获取值结果</span><br><span class="line">    # (15) model.objects.values(&quot;field&quot;).distinct() 对结果进行去重</span><br><span class="line">    # (16) model.objects.filter(field=value).order_by(&quot;-filed&quot;) 降序</span><br><span class="line">    # (17) model.objects.filter(field=value).order_by(&quot;filed&quot;) 升序</span><br><span class="line">    # (18) model.objects.filter(field=value).exists() 判断结果是否存在</span><br><span class="line">    # (19) model.objects.exclude(filed=value) 排除指定条件的数据</span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 数据库信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mysql<br>
4	jack	22	2024-06-25 13:02:38.766847	2024-06-25 13:02:38.766847<br>
5	jack	22	2024-06-25 13:02:43.551628	2024-06-25 13:02:43.551628<br>
6	tom	710	2024-06-25 13:03:09.526967	2024-06-25 13:03:09.526967<br>
7	tom	710	2024-06-25 13:03:11.030100	2024-06-25 13:03:11.030100</p>
```



![image-20240625213204352](D:\pycharm\Temporary_notes\图片\image-20240625213204352.png)

## 【三】神奇的双下划线查询



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    # 在main入口下面复制manage.py文件中main入口下面的第一行代码每一个Django项目都要自己去找 自己去复制</span><br><span class="line">    os.environ.setdefault(&#x27;DJANGO_SETTINGS_MODULE&#x27;, &#x27;Django_two.settings&#x27;)</span><br><span class="line">    # 导入模块</span><br><span class="line">    import django</span><br><span class="line"></span><br><span class="line">    # 启动方式只是临时启动，不是持久化</span><br><span class="line">    django.setup()</span><br><span class="line"></span><br><span class="line">    from user.models import UserInfo</span><br><span class="line"></span><br><span class="line">    # 神奇的双下划线</span><br><span class="line">    # 大于</span><br><span class="line">    # data = UserInfo.objects.filter(age__gt=22)</span><br><span class="line">    # # 两条数据符合</span><br><span class="line">    # print(data) # &lt;QuerySet [&lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 小于</span><br><span class="line">    # data = UserInfo.objects.filter(age__lt=22)</span><br><span class="line">    # # 没有符合条件的</span><br><span class="line">    # print(data) # &lt;QuerySet []&gt;</span><br><span class="line">    #</span><br><span class="line">    # # 大于等于</span><br><span class="line">    # data = UserInfo.objects.filter(age__gte=22)</span><br><span class="line">    # # 四条符合的数据</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (4)&gt;, &lt;UserInfo: UserInfo object (5)&gt;, &lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 小于等于</span><br><span class="line">    # data = UserInfo.objects.filter(age__lte=22)</span><br><span class="line">    # 两条条符合的数据</span><br><span class="line">    # print(data) # &lt;QuerySet [&lt;UserInfo: UserInfo object (4)&gt;, &lt;UserInfo: UserInfo object (5)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 或条件</span><br><span class="line">    # data = UserInfo.objects.filter(age__in=(18, 22))</span><br><span class="line">    # # 两条条符合的数据</span><br><span class="line">    # print(data) # &lt;QuerySet [&lt;UserInfo: UserInfo object (4)&gt;, &lt;UserInfo: UserInfo object (5)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 两个条件之间</span><br><span class="line">    # 也包含18，22</span><br><span class="line">    # data = UserInfo.objects.filter(age__range=(18, 22))</span><br><span class="line">    # #两条条符合的数据</span><br><span class="line">    # print(data)  # &lt;QuerySet [&lt;UserInfo: UserInfo object (4)&gt;, &lt;UserInfo: UserInfo object (5)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 模糊查询</span><br><span class="line">    # 查人名中带有 m 的人的名字</span><br><span class="line">    # 强约束 区分大小写</span><br><span class="line">    # data = UserInfo.objects.filter(name__contains=&quot;m&quot;)</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 弱约束 不区分大小写</span><br><span class="line">    # data = UserInfo.objects.filter(name__icontains=&quot;M&quot;)</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 以指定条件开头</span><br><span class="line">    # data = UserInfo.objects.filter(name__startswith=&quot;t&quot;)</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 以指定条件结尾</span><br><span class="line">    # data = UserInfo.objects.filter(name__endswith=&quot;m&quot;)</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 查询指定那一天</span><br><span class="line">    # data = UserInfo.objects.filter(register_time__day=&quot;20&quot;)</span><br><span class="line">    # print(data) # &lt;QuerySet []&gt;</span><br><span class="line"></span><br><span class="line">    #  查询指定那一年</span><br><span class="line">    # data = UserInfo.objects.filter(register_time__year=&quot;2024&quot;)</span><br><span class="line">    # print(data)</span><br><span class="line">    # &lt;QuerySet [&lt;UserInfo: UserInfo object (4)&gt;, &lt;UserInfo: UserInfo object (5)&gt;, &lt;UserInfo: UserInfo object (6)&gt;, &lt;UserInfo: UserInfo object (7)&gt;]&gt;</span><br><span class="line"></span><br><span class="line">    # 查询指定那一月</span><br><span class="line">    data = UserInfo.objects.filter(register_time__month=&quot;5&quot;)</span><br><span class="line">    print(data) # &lt;QuerySet []&gt;</span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 数据库信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mysql<br>
4	jack	22	2024-06-25 13:02:38.766847	2024-06-25 13:02:38.766847<br>
5	jack	22	2024-06-25 13:02:43.551628	2024-06-25 13:02:43.551628<br>
6	tom	710	2024-06-25 13:03:09.526967	2024-06-25 13:03:09.526967<br>
7	tom	710	2024-06-25 13:03:11.030100	2024-06-25 13:03:11.030100</p>
```



![image-20240625213204352](D:\pycharm\Temporary_notes\图片\image-20240625213204352.png)

## 【四】创建多表关系

- 既然是多表查询，那就是不止一个表
- 在models.py文件中创建多个表
- 我们学过的表查询有
  - 一对一查询
  - 一对多查询
  - 多对多查询

### 【1】一对多的表

- ForeignKey方法创建一对多关系

创建图书表



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line"># 创建的是图书表</span><br><span class="line">class Book(models.Model):</span><br><span class="line">    # 标题</span><br><span class="line">    title = models.CharField(max_length=32)</span><br><span class="line">    # 价格</span><br><span class="line">    # max_digits：最多几位</span><br><span class="line">    # decimal_places：最多小数点后面几位</span><br><span class="line">    # DecimalField：小数类型</span><br><span class="line">    price = models.DecimalField(max_digits=8, decimal_places=2)</span><br><span class="line">    # 一对多关系，图书与出版社</span><br><span class="line">    publisher = models.ForeignKey(</span><br><span class="line">        # 目标建立关系的表</span><br><span class="line">        to=&quot;Publisher&quot;,</span><br><span class="line">        # 级联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建出版社表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>python</p>
<h1>创建出版社表</h1>
<p>class Publisher(models.Model):<br>
# 名字<br>
name = models.CharField(max_length=32)<br>
# 地址<br>
addr = models.CharField(max_length=32)</p>
```



### 【2】一对一的表

- OneToOneField方法创建一对一关系

创建作者表



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line"># # 创建作者表</span><br><span class="line">class Author(models.Model):</span><br><span class="line">    # 名字</span><br><span class="line">    name = models.CharField(max_length=32)</span><br><span class="line">    # 年龄</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line">    # 作者和作者详情表进行关联，一对一关系，一个作者只能有一个详情</span><br><span class="line">    # 一个详情对应一个作者</span><br><span class="line">    author_detail = models.OneToOneField(</span><br><span class="line">        # 目标建立关系的表,作者详情表</span><br><span class="line">        to=&quot;AuthorDetail&quot;,</span><br><span class="line">        # 联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建作者详情表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>python</p>
<h1>创建作者详情表</h1>
<p>class AuthorDetail(models.Model):<br>
# 地址<br>
addr = models.CharField(max_length=32)<br>
# 电话<br>
phone = models.CharField(max_length=11)</p>
```



### 【3】多对多的表

- ManyToManyField方法创建多对多关系

- 需要第三张表存放两个表的关系

创建图书表



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line"># 创建的是图书表</span><br><span class="line">class Book(models.Model):</span><br><span class="line">    # 标题</span><br><span class="line">    title = models.CharField(max_length=32)</span><br><span class="line">    # 价格</span><br><span class="line">    # max_digits：最多几位</span><br><span class="line">    # decimal_places：最多小数点后面几位</span><br><span class="line">    # DecimalField：小数类型</span><br><span class="line">    price = models.DecimalField(max_digits=8, decimal_places=2)</span><br><span class="line"></span><br><span class="line">    # 一对多关系，图书与出版社</span><br><span class="line">    publisher = models.ForeignKey(</span><br><span class="line">        # 目标建立关系的表</span><br><span class="line">        to=&quot;Publisher&quot;,</span><br><span class="line">        # 级联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # 多对多的关系</span><br><span class="line">    auther = models.ManyToManyField(</span><br><span class="line">        # 目标建立关系的表</span><br><span class="line">        to=&quot;Author&quot;,</span><br><span class="line">        # 级联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete = models.CASCADE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建作者表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>python</p>
<h1>创建作者表</h1>
<p>class Author(models.Model):<br>
# 名字<br>
name = models.CharField(max_length=32)<br>
# 年龄<br>
age = models.IntegerField()<br>
# 作者和作者详情表进行关联，一对一关系，一个作者只能有一个详情<br>
# 一个详情对应一个作者<br>
author_detail = models.OneToOneField(<br>
# 目标建立关系的表,作者详情表<br>
to=“AuthorDetail”,<br>
# 联更新和级联删除，和并在一起了<br>
on_delete=models.CASCADE<br>
)<br>
# 与作者建立的第三张表<br>
book = models.ManyToManyField(<br>
# 跟那张表进行关联<br>
to=“Book”,<br>
# 联更新和级联删除，和并在一起了<br>
on_delete=models.CASCADE<br>
)</p>
```



创建图书和作者表关系表



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python</span><br><span class="line"># 作者和书的关系表</span><br><span class="line">class BookToAuthor(models.Model):</span><br><span class="line">    # 字段关联作者表</span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        # 关联作者的表</span><br><span class="line">        to=&quot;Author&quot;,</span><br><span class="line">        # 级联更新和级联删除</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line">    # 字段关联图书的表</span><br><span class="line">    book = models.ForeignKey(</span><br><span class="line">        # 关联图书的表</span><br><span class="line">        to=&quot;Book&quot;,</span><br><span class="line">        # 目标建立关系的表</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 【4】多对多的表方法二</span><br><span class="line"></span><br><span class="line">- 直接在这两张表的其中一张上建立第三张表</span><br><span class="line"></span><br><span class="line">比如我们在Book上建立</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>python<br>
class Book(models.Model):<br>
# 标题<br>
title = models.CharField(max_length=32)<br>
# 价格<br>
# max_digits：最多几位<br>
# decimal_places：最多小数点后面几位<br>
# DecimalField：小数类型<br>
price = models.DecimalField(max_digits=8, decimal_places=2)<br>
# 一对多关系，图书与出版社<br>
publisher = models.ForeignKey(<br>
# 目标建立关系的表<br>
to=“Publisher”,<br>
# 级联更新和级联删除，和并在一起了<br>
on_delete=models.CASCADE<br>
)</p>
<pre><code># 多对多的关系
auther = models.ManyToManyField(
    to=&quot;Author&quot;
)
</code></pre>
``````python
  # 多对多的关系
    auther = models.ManyToManyField(
        to="Author"
    )
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- Django会自动创建第三张表</span><br><span class="line"></span><br><span class="line">### 【5】总的创建表代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line"># 创建出版社表</span><br><span class="line">class Publisher(models.Model):</span><br><span class="line">    # 名字</span><br><span class="line">    name = models.CharField(max_length=32)</span><br><span class="line">    # 地址</span><br><span class="line">    addr = models.CharField(max_length=32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建的是图书表</span><br><span class="line">class Book(models.Model):</span><br><span class="line">    # 标题</span><br><span class="line">    title = models.CharField(max_length=32)</span><br><span class="line">    # 价格</span><br><span class="line">    # max_digits：最多几位</span><br><span class="line">    # decimal_places：最多小数点后面几位</span><br><span class="line">    # DecimalField：小数类型</span><br><span class="line">    price = models.DecimalField(max_digits=8, decimal_places=2)</span><br><span class="line">    # 一对多关系，图书与出版社</span><br><span class="line">    publisher = models.ForeignKey(</span><br><span class="line">        # 目标建立关系的表</span><br><span class="line">        to=&quot;Publisher&quot;,</span><br><span class="line">        # 级联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # 多对多的关系</span><br><span class="line">    auther = models.ManyToManyField(</span><br><span class="line">        to=&quot;Author&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建作者详情表</span><br><span class="line">class AuthorDetail(models.Model):</span><br><span class="line">    # 地址</span><br><span class="line">    addr = models.CharField(max_length=32)</span><br><span class="line">    # 电话</span><br><span class="line">    phone = models.CharField(max_length=11)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># # 创建作者表</span><br><span class="line">class Author(models.Model):</span><br><span class="line">    # 名字</span><br><span class="line">    name = models.CharField(max_length=32)</span><br><span class="line">    # 年龄</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line">    # 作者和作者详情表进行关联，一对一关系，一个作者只能有一个详情</span><br><span class="line">    # 一个详情对应一个作者</span><br><span class="line">    author_detail = models.OneToOneField(</span><br><span class="line">        # 目标建立关系的表,作者详情表</span><br><span class="line">        to=&quot;AuthorDetail&quot;,</span><br><span class="line">        # 联更新和级联删除，和并在一起了</span><br><span class="line">        on_delete=models.CASCADE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"># 记得迁移数据库</span><br></pre></td></tr></table></figure>

<h2 id="【五】一对多的外键字段">【五】一对多的外键字段</h2>
<h3 id="【1】添加值">【1】添加值</h3>
<ul>
<li>create</li>
</ul>
```python
 # 【一】一对多表外键字段
    # 【1】添加数据  create
    #  Publish.objects.create(name="人民出版社", addr="北京")
    # Publish.objects.create(name="上海出版社", addr="上海")
    # Publish.objects.create(name="南京出版社", addr="南京")
    # Publish.objects.create(name="东京出版社", addr="东京")
    
    # 在创建图书数据的时候要进行出版社的关联
    # publish_obj = Publish.objects.get(pk=2)
    # 方式一 ： 直接在 字段 publish_id 值是指定出版社的id
    # Book.objects.create(title="西游记", price="99",publish_id=publish_obj.id)
    # 方式二 ： 在模型表中定义的字段是叫 publish 所以 直接将对象扔进去
    # Book.objects.create(title="红楼梦", price="88", publish=publish_obj)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 【2】删除数据</span><br><span class="line"></span><br><span class="line">- delete</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 【2】删除数据--删除外键关系  delete</span><br><span class="line">    # book中的publisher字段</span><br><span class="line">    # 因为你在创建的时候已经添加了级联更新和级联删除所以你删除信息和修改信息都会发生变化</span><br><span class="line">    # Book.objects.get(pk=&quot;1&quot;).delete()# 删除了book id为1的数据</span><br><span class="line">    # Publisher.objects.get(pk=&quot;1&quot;).delete()# 删除了出版社的id，对应的图书也一并被删掉了</span><br><span class="line">    # 删除外键数据 出版社表中的数据 在图书表中 预支相关联的数据也会被删除</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="【3】修改外键字段">【3】修改外键字段</h3>
<ul>
<li>update</li>
</ul>
```python
 # 【3】修改外键字段 update
    # 我们将红楼梦从1出版社转到3出版社该怎么做
    # 方法一
    # 我们先获得出版社的一个id
    # publisher_obj = Publisher.objects.get(pk="4")

    # Book.objects.filter(title="红楼梦").update(publisher=publisher_obj)
    
    # 方法二
    # 直接替换,指定书的id，替换指定印刷厂的id
    # id不存在就会报错
    # books = Book.objects.filter(pk=6).update(publisher_id=6)
	# 也可以放对象
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 【六】多对多的外键字段</span><br><span class="line"></span><br><span class="line">### 【1】添加数据</span><br><span class="line"></span><br><span class="line">- 一定要保证两个表里面有值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 图书和作者表</span><br><span class="line">    # for i in range(1, 6):</span><br><span class="line">    #     detail_obj = AuthorDetail.objects.create(addr=f&quot;上海_&#123;i&#125;&quot;, phone=f&quot;1&#123;i&#125;0&quot;)</span><br><span class="line">    #     # print(detail_obj) # AuthorDetail object (1)</span><br><span class="line">    #     Author.objects.create(name=f&quot;dream_&#123;i&#125;&quot;, age=18 * i, author_detail=detail_obj)</span><br><span class="line"></span><br><span class="line">    # for i in range(1, 6):</span><br><span class="line">    #     Book.objects.create(</span><br><span class="line">    #         title=f&quot;第 &#123;i&#125; 本书&quot;,</span><br><span class="line">    #         price=str(60 * i),</span><br><span class="line">    #         publish_id=random.randint(2, 6)</span><br><span class="line">    #     )</span><br></pre></td></tr></table></figure>

<ul>
<li>要使用Django自带的机制自动生成的第三张表，models不会有第三张表</li>
<li>需要跨表建立关系</li>
</ul>
```python
# 获得书籍对象
    data = book_obj = Book.objects.get(pk=16)

    # 获得作者对象
    data = auther_obj = Author.objects.get(pk=3)

     # 【1】添加多对多外键关系---关键字add
    # 方式一
    # 给book_obj书籍添加一个作者
    # 获得书籍对象，在获得作者对象，书籍对象在跨到作者身上
    # 你的第三章表建立建立谁的身上了就得到谁的对象然后在把和你建立多对多关系的表添加进去
    # data = book_obj.auther.add(auther_obj)
    # print(data)
    # 方式二 直接放作者的id号
    # book_obj.auther.add(1, 3,6,4,5)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 【2】删除数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 获得书籍对象</span><br><span class="line">    data = book_obj = Book.objects.get(pk=16)</span><br><span class="line"></span><br><span class="line">    # 获得作者对象</span><br><span class="line">    data = auther_obj = Author.objects.get(pk=3)</span><br><span class="line"></span><br><span class="line"># 【2】删除多对多外键关系 remove</span><br><span class="line">    # book_obj.auther.remove(auther_obj)</span><br><span class="line">    # 删除多个，直接给作者的id</span><br><span class="line">    # book_obj.auther.remove(3, 1)</span><br></pre></td></tr></table></figure>

<h3 id="【3】修改外键关系">【3】修改外键关系</h3>
```python
 # 获得书籍对象
    data = book_obj = Book.objects.get(pk=16)

    # 获得作者对象
    data = auther_obj = Author.objects.get(pk=3)

    # 【3】修改外键关系---》set
    # 方式一 用set方法，弊端就是会清空其他的外键关系
    # set关键字是一个列表
    # 修改了数据，保留了book_obj是16对应的3，其他的book_obj对应的书籍被清空，
    # book_obj.auther.set([3])
    # 方式二 先用 remove 移除外键关系 再用 add 添加外键关系
    # book_obj.auther.remove(auther_obj)
    # book_obj.auther.add(auther_obj)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 多表查询（正反向查询）</span><br><span class="line"></span><br><span class="line">## 【一】什么是正反向查询</span><br><span class="line"></span><br><span class="line">### 【1】正向查询</span><br><span class="line"></span><br><span class="line">- 外键字段在自己身上就叫正向查询</span><br><span class="line">  - 有外键关系的两张表 从有外检字段的表向另一张无外键字段的表查询数据的时候就是正向</span><br><span class="line">- 正向查询的时候，直接按照字段查询</span><br><span class="line"></span><br><span class="line">### 【2】反向查询</span><br><span class="line"></span><br><span class="line">- 外键字段不在自己身上，我查你就叫反向查询</span><br><span class="line">  - 有外键关系的两张表 从无外键字段的表向另一张有外键字段表查询数据的时候就是反向</span><br><span class="line">- 反向查询的时候，要使用关键字_set</span><br><span class="line"></span><br><span class="line">## 【二】多表查询案例</span><br><span class="line"></span><br><span class="line">### 【1】子查询（基于对象的跨表查询）</span><br><span class="line"></span><br><span class="line">#### （1）查询书籍主键为14的出版社</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">	#查询书籍主键为1的出版社</span><br><span class="line">    #得到图书对象</span><br><span class="line">    book_obj = Book.objects.get(pk=14)</span><br><span class="line">    #图书与出版社是一对多关系</span><br><span class="line">    print(book_obj)  # Book object (14)</span><br><span class="line">    #不要带_id</span><br><span class="line">    publisher_id = book_obj.publisher_id</span><br><span class="line">    print(publisher_id)  # 6</span><br><span class="line">    #得到出版社对象</span><br><span class="line">    publisher_obj = book_obj.publisher</span><br><span class="line">    print(publisher_obj)  # Publisher object (6)</span><br><span class="line">    #对象.name得到出版社</span><br><span class="line">    publisher_name = book_obj.publisher.name</span><br><span class="line">    print(publisher_name)  # 4出版社</span><br></pre></td></tr></table></figure>

<h4 id="（2）查询数据主键为1的作者">（2）查询数据主键为1的作者</h4>
```python
 	# 查询书籍主键为1的作者
    # 书籍与作者是多对多关系
    # 得到主键id为1的对象
    book_obj = Book.objects.filter(pk=1).first()
    print(book_obj) # Book object (1)
    res = book_obj.auther
    print(res)  # user.Author.None
    auther_obj = book_obj.auther.all()
    print(auther_obj)  # <QuerySet [<Author: Author object (2)>]>
    author_obj = book_obj.auther.all().values("name")
    print(author_obj)  # <QuerySet [{'name': 'tom2'}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### (3)查询作者主键为3的电话号码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">	# 查询作者主键为3的电话号码</span><br><span class="line">    # 得到作者对象</span><br><span class="line">    # 作者与作者详情是一对一关系</span><br><span class="line">    author_obj = Author.objects.filter(pk=3).first()</span><br><span class="line">    print(author_obj)  # Author object (3)</span><br><span class="line">    # 得到作者详情对象</span><br><span class="line">    author_detail_obj = author_obj.author_detail</span><br><span class="line">    print(author_detail_obj)  # AuthorDetail object (3)</span><br><span class="line">    # 对象.字段</span><br><span class="line">    phone = author_detail_obj.phone</span><br><span class="line">    print(phone)  # 130</span><br></pre></td></tr></table></figure>

<h4 id="4-查询出版社是-1出版社-的书">(4)查询出版社是  1出版社  的书</h4>
<ul>
<li>在下面<code>res</code>只是一个待执行的查询的“准备”状态</li>
</ul>
```python
	# 查询出版社是  1出版社  的书
    # 出版社与书是多对一关系
    # 没有外键关系的表要向有外键关系的表查，就是反向查询加_set
    # 得到出版社对象
    publisher_obj = Publisher.objects.filter(name="1出版社").first()
    print(publisher_obj)  # Publisher object (2)
    # 反向查询加_set
    # 只是一个执行状态的准备，并没有进行查询
    res = publisher_obj.book_set
    print(res)  # user.Book.None
    # 得到图书对象
    book_obj = publisher_obj.book_set.all()
    print(book_obj)  # <QuerySet [<Book: Book object (1)>]>
    # values得到想要的数据
    publisher_name = publisher_obj.book_set.all().values("title")
    print(publisher_name)  # <QuerySet [{'title': '第1本书'}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （5）查询作者是tom1写过的书</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">	# 查询作者是tom1写过的书</span><br><span class="line">    # 作者和图书是多对多关系</span><br><span class="line">    # 得到作者的对象</span><br><span class="line">    author_obj = Author.objects.filter(name=&quot;tom1&quot;).first()</span><br><span class="line">    print(author_obj)  # Author object (1)</span><br><span class="line">    # 得到图书对象</span><br><span class="line">    book_obj = author_obj.book_set</span><br><span class="line">    print(book_obj)  # user.Book.None</span><br><span class="line">    # 得到图书的名字</span><br><span class="line">    book_name = author_obj.book_set.all().values(&quot;title&quot;)</span><br><span class="line">    print(book_name)  # &lt;QuerySet [&#123;&#x27;title&#x27;: &#x27;第3本书&#x27;&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="6-查询手机号是110的作者姓名">(6)查询手机号是110的作者姓名</h4>
```python
# 查询手机号是110的作者姓名
    # 作者和作者详情是一对一关系
    # 得到作者详情对象
    author_detail_obj = AuthorDetail.objects.filter(phone=110).first()
    print(author_detail_obj)
    # 主键在作者身上，反向查询，但是是一对一关系，不需要加_set
    author_obj = author_detail_obj.author
    print(author_obj)  # Author object (1)
    # 得到作者的名字
    author_name = author_obj.name
    print(author_name)  # tom1
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### (7)小结</span><br><span class="line"></span><br><span class="line">- 基于对象的反向查询</span><br><span class="line">- 什么时候需要加_set.all()</span><br><span class="line">  - 查询结果是多个的时候需要加</span><br><span class="line">- 一对一表关系不区分正反向 因为关系唯一</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 正向查询：有外键字段向没有外键字段的表查 查询方式是 .字段名</span><br><span class="line"># 反向查询：没有外键字段向有外键字段的表查 查询方式时 .有外键字段的表明_set</span><br></pre></td></tr></table></figure>

<h3 id="【2】联表查询">【2】联表查询</h3>
<ul>
<li>基于双下划线的跨表查询</li>
<li>联表查询就是将两张表合并在一起查询数据</li>
</ul>
<h4 id="（1）查询tom1的手机号和作者的名字">（1）查询tom1的手机号和作者的名字</h4>
<ul>
<li>
<p>正向查询</p>
</li>
<li>
<p>使用双下划线（查询信息的表明__字段）</p>
</li>
<li>
<p>查询到作者信息在.value.(需要查询信息的表__需要查询的字段,其他字段)</p>
</li>
</ul>
```python
	# 查询tom1的手机号和作者的名字
    # 正向查询
    # 作者和作者详情是一对一关系
    name_phone = Author.objects.filter(name="tom1").values(
        "name",
        "author_detail__phone"
    )
    print(name_phone)
    # <QuerySet [{'name': 'tom1', 'author_detail__phone': '110'}]>
    # first：取到单个数据
    author_dict = name_phone.first()
    print(author_dict)  # {'name': 'tom1', 'author_detail__phone': '110'}
    # 取到名字
    name = name_phone.first().get("name")
    print(name)  # tom1
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 反向查询</span><br><span class="line">- 先拿到详情，再用作者详情关联作者表，通过 __字段的方法 过滤出我们想要的指定数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 查询tom1的手机号和作者的名字</span><br><span class="line">    # 反向查询</span><br><span class="line">    phone_name = AuthorDetail.objects.filter(author__name=&quot;tom1&quot;).values(</span><br><span class="line">        &quot;phone&quot;,</span><br><span class="line">        &quot;author__name&quot;</span><br><span class="line">    )</span><br><span class="line">    print(phone_name)</span><br><span class="line">    # &lt;QuerySet [&#123;&#x27;phone&#x27;: &#x27;110&#x27;, &#x27;author__name&#x27;: &#x27;tom1&#x27;&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="（2）查询书籍主键为1的出版社的名字和书的名字">（2）查询书籍主键为1的出版社的名字和书的名字</h4>
<ul>
<li>正向查询</li>
<li>先过滤出书籍ID为1的书籍对象，再去关联出版者表，利用__字段取值</li>
</ul>
```python
# 查询书籍主键为1的出版社的名字和书的名字
    # 正向查询
    data = Book.objects.filter(pk=1).values(
        "title",
        "publisher__name"
    )
    print(data)
    # <QuerySet [{'title': '第1本书', 'publisher__name': '1出版社'}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 反向查询</span><br><span class="line">- 先查询到指定出版社，再从出版社反向找到书籍名字</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 查询书籍主键为1的出版社的名字和书的名字</span><br><span class="line">    # 反向查询</span><br><span class="line">    data = Publisher.objects.filter(book__id=1).values(</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;book__title&quot;</span><br><span class="line">    )</span><br><span class="line">    print(data)</span><br><span class="line">    # &lt;QuerySet [&#123;&#x27;name&#x27;: &#x27;1出版社&#x27;, &#x27;book__title&#x27;: &#x27;第1本书&#x27;&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-查询书籍主键为1的作者的名字">(3)查询书籍主键为1的作者的名字</h4>
<ul>
<li>正向</li>
<li>先拿到 书籍主键ID为1的对象，再关联作者信息表，通过__字段取值</li>
</ul>
```python
# 查询书籍主键为1的作者的名字
    data = Book.objects.filter(pk=1).values(
        "auther__name"
    )
    print(data)  # <QuerySet [{'auther__name': 'tom2'}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 反向</span><br><span class="line">- 先拿到 书籍ID为1的作者数据再去取作者的名字</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 查询书籍主键为1的作者的名字</span><br><span class="line">    data = Author.objects.filter(book__id=1).values(</span><br><span class="line">        &quot;name&quot;</span><br><span class="line">    )</span><br><span class="line">    print(data)  # &lt;QuerySet [&#123;&#x27;name&#x27;: &#x27;tom2&#x27;&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="4-查询书籍主键为1的作者的手机号">(4)查询书籍主键为1的作者的手机号</h4>
<ul>
<li>跨越了三个表</li>
</ul>
```python
# 查询书籍主键为1的作者的手机号
    data = Author.objects.filter(book__id=1).values(
        "author_detail__phone"
    )
    print(data)  # <QuerySet [{'author_detail__phone': '120'}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （5）小结</span><br><span class="line"></span><br><span class="line">- 掌握了双下划线和正反向可以无限跨表</span><br><span class="line"></span><br><span class="line">## 【三】聚合函数（aggregate）</span><br><span class="line"></span><br><span class="line">- 正常情况下我们需要进行分组才能进行聚合函数的运算</span><br><span class="line"></span><br><span class="line">- 使用聚合函数时：利用关键字aggregate可以不分组进行某个字段的聚合函数</span><br><span class="line"></span><br><span class="line">### 【1】引入聚合函数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db.models import Max, Min, Sum, Count, Avg</span><br></pre></td></tr></table></figure>

<h3 id="【2】聚合函数案例">【2】聚合函数案例</h3>
<ul>
<li>第一步需要先导入聚合函数</li>
</ul>
```python
from django.db.models import Max, Min, Sum, Count, Avg
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### (1)求所有书的平均价格</span><br><span class="line"></span><br><span class="line">- 利用聚合函数不用分组就可以的到的结果的方法：aggregate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 求所有书的平均数</span><br><span class="line">    from django.db.models import Sum, Avg</span><br><span class="line">    book_avg_price = Book.objects.aggregate(Avg(&quot;price&quot;))</span><br><span class="line">    print(book_avg_price)</span><br><span class="line">    # &#123;&#x27;price__avg&#x27;: Decimal(&#x27;60.000000&#x27;)&#125;</span><br><span class="line">    from django.db.models import Sum, Avg</span><br><span class="line">    book_avg_price = Book.objects.aggregate(Avg(&quot;price&quot;))</span><br><span class="line">    print(book_avg_price)</span><br><span class="line">    # &#123;&#x27;price__avg&#x27;: Decimal(&#x27;60.000000&#x27;)&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-一次性用很多方法">(2)一次性用很多方法</h4>
<ul>
<li>利用聚合函数不用分组就可以的到的结果的方法：aggregate</li>
</ul>
```python
from django.db.models import Sum, Avg, Max, Min, Count

    book_avg_price = Book.objects.aggregate(Avg("price"), Max("price"), Min("price"), Sum("price"), Count("price"))
    print(book_avg_price)
    # {'price__avg': Decimal('60.000000'), 'price__max': Decimal('100.00'), 'price__min': Decimal('20.00'), 'price__sum': Decimal('300.00'), 'price__count': 5}
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 【四】分组查询（关键字：annotate）</span><br><span class="line"></span><br><span class="line">### 【1】引入</span><br><span class="line"></span><br><span class="line">- 按照指定条件对数据进行分组</span><br><span class="line"></span><br><span class="line">### 【2】分组查询语法</span><br><span class="line"></span><br><span class="line">- models 后面跟的是什么，就是按什么分组</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">res = models.Book.objects.annotate()</span><br></pre></td></tr></table></figure>

<h3 id="【3】案例">【3】案例</h3>
<h4 id="（1）统计每一本书的作者个数">（1）统计每一本书的作者个数</h4>
<ul>
<li>Book分组，然后计算作者的个数</li>
</ul>
```python
 from django.db.models import Count, Avg, Max, Min, Sum
 from user.models import Book
    # 统计每一本书的作者个数
    # 一定要看你的字段名写错了没，错了就会找不到数据
    # 获得分组后的对象
    data = Book.objects.annotate(author_number=Count("auther"))
    print(data)  # <QuerySet [<Book: Book object (1)>, <Book: Book object (2)>, <Book: Book object (15)>, <Book: Book object (16)>, <Book: Book object (17)>]>
    
    # 获得分组后的数据
    data = Book.objects.annotate(author_number=Count("auther")).values(
        "title",
        "author_number"
    )
    print(data)
    # <QuerySet [{'title': '第1本书', 'author_number': 1}, {'title': '第2本书', 'author_number': 0}, {'title': '第3本书', 'author_number': 4}, {'title': '第4本书', 'author_number': 1}, {'title': '第5本书', 'author_number': 0}]>
    
    
    
    
    # 等价于
     data = Book.objects.annotate(author_number=Count("auther__pk")).values(
        "title",
        "author_number"
    )
    print(data)
    # <QuerySet [{'title': '第1本书', 'author_number': 1}, {'title': '第2本书', 'author_number': 0}, {'title': '第3本书', 'author_number': 4}, {'title': '第4本书', 'author_number': 1}, {'title': '第5本书', 'author_number': 0}]>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （2）统计每个出版社最便宜的书的价格</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">    from django.db.models import Count, Avg, Max, Min, Sum</span><br><span class="line">    from user.models import  Publisher</span><br><span class="line"></span><br><span class="line">    # 统计每个出版社最便宜的书的价格</span><br><span class="line">    data = Publisher.objects.annotate(min_book_price=Min(&#x27;book__price&#x27;)).values(</span><br><span class="line">        &#x27;name&#x27;,</span><br><span class="line">        &quot;min_book_price&quot;</span><br><span class="line">    )</span><br><span class="line">    print(data)</span><br><span class="line">    # &lt;QuerySet [&#123;&#x27;name&#x27;: &#x27;1出版社&#x27;, &#x27;min_book_price&#x27;: Decimal(&#x27;20.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;4出版社&#x27;, &#x27;min_book_price&#x27;: Decimal(&#x27;40.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;2出版社&#x27;, &#x27;min_book_price&#x27;: Decimal(&#x27;80.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;3出版社&#x27;, &#x27;min_book_price&#x27;: Decimal(&#x27;100.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;5出版社&#x27;, &#x27;min_book_price&#x27;: None&#125;]&gt;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h4 id="（3）统计不止一个作者的图书">（3）统计不止一个作者的图书</h4>
```python
from django.db.models import Count, Avg, Max, Min, Sum
    from user.models import Book
    # 统计不止一个作者的图书
    # 先按图书分组
    # 再筛选不止一个作者的图书
    data = Book.objects.annotate(one_author=Count("auther")).filter(one_author__gt=1).values(
        "title",
        "one_author"
    )
    print(data)  # <QuerySet [{'title': '第3本书', 'one_author': 4}]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### (4)查询每个作者出的书总价格</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db.models import Count, Avg, Max, Min, Sum</span><br><span class="line">    from user.models import Author</span><br><span class="line"></span><br><span class="line">    # 查询每个作者出的书总价格</span><br><span class="line">    data = Author.objects.annotate(sum_book_price=Sum(&quot;book__price&quot;)).values(</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;sum_book_price&quot;</span><br><span class="line">    )</span><br><span class="line">    print(data)</span><br><span class="line">    # &lt;QuerySet [&#123;&#x27;name&#x27;: &#x27;tom2&#x27;, &#x27;sum_book_price&#x27;: Decimal(&#x27;80.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;tom1&#x27;, &#x27;sum_book_price&#x27;: Decimal(&#x27;60.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;tom3&#x27;, &#x27;sum_book_price&#x27;: Decimal(&#x27;140.00&#x27;)&#125;, &#123;&#x27;name&#x27;: &#x27;tom4&#x27;, &#x27;sum_book_price&#x27;: Decimal(&#x27;60.00&#x27;)&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="5-小结">(5)小结</h4>
<ul>
<li>
<p>下面这个语法</p>
</li>
<li>
```python
  Book.objects.values('price').annotate()
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 如果annotate前面没东西，则会按照Book进行分组,如果前面有参数就会按照前面的参数&#x27;price&#x27;进行分组</span><br><span class="line"></span><br><span class="line">## 【五】F和Q查询</span><br><span class="line"></span><br><span class="line">### 【1】引入</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from from django.db.models import F, Q</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="【2】F查询">【2】F查询</h3>
<ul>
<li>能够帮你获取到列表中的某个字段对应的数据</li>
<li>注意：在操作字符串类型的时候，F查询不能够直接做到字符串的拼接</li>
</ul>
<h4 id="（1）查询库存数大于销量的书籍">（1）查询库存数大于销量的书籍</h4>
```python
# F 查询 : 帮助我们直接获取到表中的某个字段对应的数据
res = models.Book.objects.filter(sales__gt=F('stock'))
print(res)  # <QuerySet [<Book: 水浒传>]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （2）将所有的书籍价格提升100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">	from user.models import Book</span><br><span class="line">    from django.db.models import F</span><br><span class="line"></span><br><span class="line">    # 将所有的书籍价格提升100</span><br><span class="line">    data = Book.objects.update(price=F(&quot;price&quot;) + 100)</span><br><span class="line">    print(data)</span><br><span class="line">    # 5</span><br><span class="line">    # 代表更新了5条数据</span><br></pre></td></tr></table></figure>

<h4 id="3-将所有的数据后面添加-nb">(3)将所有的数据后面添加_nb</h4>
<ul>
<li>
<p>Value 是一个用于在查询中插入静态值的类，这个值可以是任何Django支持的数据库数据类型</p>
<ul>
<li>
```python
    from django.db.models import Value
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- Concat:在操作字符串的时候F查询不能直接操作字符串，需要引入这个方法</span><br><span class="line"></span><br><span class="line">  - &#123;% raw %&#125;````python</span><br><span class="line">    from django.db.models.functions import Concat</span><br><span class="line">    ````</span><br><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from user.models import Book</span><br><span class="line">    from django.db.models import F</span><br><span class="line">    from django.db.models import Value</span><br><span class="line">    from django.db.models.functions import Concat</span><br><span class="line">    # 将所有的书籍后面添加_nb</span><br><span class="line">    # 在操作字符串的时候F查询不能直接操作字符串，需要引入一个方法，Concat</span><br><span class="line">    # Value：Value 是一个用于在查询中插入静态值的类，这个值可以是任何Django支持的数据库数据类型</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    data = Book.objects.update(title=Concat(F(&quot;title&quot;),Value(&#x27;_nb&#x27;)))</span><br><span class="line">    print(data)</span><br><span class="line">    # 5</span><br><span class="line">    # 更新了5条数据</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="【3】Q查询">【3】Q查询</h3>
<ul>
<li>关键字filter()方法中的关键字参数查询都是一起进行’and’</li>
<li>如果你需要执行更复杂的查询(列如ORM语句)，你可以使用Q对象</li>
</ul>
<h4 id="1-查询卖出数大于100或者价格小于500的书籍">(1)查询卖出数大于100或者价格小于500的书籍</h4>
<ul>
<li>直接使用 filter 查询数据，逗号隔开,里面放的参数是 and 关系</li>
<li>两个条件都必须符合</li>
</ul>
```python
# 查询卖出数大于100或者价格小于500的书籍
    data = Book.objects.filter(sales__gt=100, price__lt=500)
    print(data)
    # <QuerySet [<Book: Book object (1)>]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 直接使用 Q 查询数据，逗号隔开,里面放的参数还是 and 关系</span><br><span class="line">  - 两个条件都必须成立</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">data = Book.objects.filter(Q(sales__gt=100), Q(price__lt=500))</span><br><span class="line">    print(data)  # &lt;QuerySet [&lt;Book: Book object (1)&gt;]&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>
<p>直接使用 Q 查询数据，逗号可以换成其他连接符达到效果</p>
<ul>
<li>
<p>or：任一个条件符合即可</p>
</li>
<li>
<p>关键字作为连接符，会阉割条件</p>
```python
    data = Book.objects.filter(Q(sales__gt=100) or Q(price__lt=500))
        print(data)  # <QuerySet [<Book: Book object (1)>]>
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  - |：或关系</span><br><span class="line"></span><br><span class="line">    - 有一个成立就可以</span><br><span class="line"></span><br><span class="line">  &#123;% raw %&#125;```python</span><br><span class="line">  data = Book.objects.filter(Q(sales__gt=100) | Q(price__lt=500))</span><br><span class="line">      print(data) # &lt;QuerySet [&lt;Book: Book object (1)&gt;]&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="（2）Q的高阶用法">（2）Q的高阶用法</h4>
<ul>
<li>
<p>能够将查询条件的左边也变成 字符串形式</p>
</li>
<li>
<p>自己创造查询条件</p>
</li>
</ul>
```python
from django.db.models import Q

    # 查询卖出数大于100或者价格小于500的书籍

    # 生成Q对象
    q = Q()
    # 创建Q对象的连接条件
    # or：满足一个条件即可
    # and: 两个条件都要满足
    # 默认是and关系
    q.connector = "or"
    # 添加第一个加条件-->左边
    q.children.append(("sales__gt", 100))
    # 添加第二个加条件-->右边
    q.children.append(("price__lt", 500))
    # 查询
    # filter 除了可以放条件 还可以放对象
    data = Book.objects.filter(q)
    print(data)  # <QuerySet [<Book: Book object (1)>]>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 可以在去对象内 children里面 无限制的添加元素 添加元组，元组里两个元素</span><br><span class="line"></span><br><span class="line">- 而且还支持修改 or 、and</span><br><span class="line">- 默认是and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line"># 或查询</span><br><span class="line">q = Q()</span><br><span class="line">q |= Q(条件一)</span><br><span class="line">q |= Q(条件二)</span><br><span class="line">qs = Model.objects.filter(q)</span><br><span class="line"></span><br><span class="line"># 并查询</span><br><span class="line">q = Q()</span><br><span class="line">q &amp;= Q(条件一)</span><br><span class="line">q &amp;= Q(条件二)</span><br><span class="line">qs = Model.objects.filter(q)</span><br></pre></td></tr></table></figure>

<h1>Django中开启事务</h1>
<h2 id="【一】ACID特性">【一】ACID特性</h2>
<ul>
<li>原子性（Atomicity）
<ul>
<li>事务被称为一个不可再分隔的原子操作单位</li>
<li>要么全部操作成功并永久保存，要么全部操作失败并回滚到事务开始前的状态，不存在部分成功或部分失败的情况</li>
</ul>
</li>
<li>一致性（Consistency）
<ul>
<li>事务执行前后，数据库应保持一致的状态</li>
<li>在事务开始之前和结束之后，数据库必须满足所有的完整性约束，如列级别的约束、外键关系等</li>
</ul>
</li>
<li>隔离性（Isolation）
<ul>
<li>事务的执行结果对其他并发执行的事务是隔离的</li>
<li>一个事务的执行不应受到其他事务的干扰，各个事务之间应该相互独立工作，从而避免数据的不一致性</li>
</ul>
</li>
<li>持久性（Durability）
<ul>
<li>一旦事务被提交，其结果应该永久保存在数据库中，并且可以被系统故障恢复</li>
<li>即使系统发生宕机或崩溃，事务提交后的更改也应该是永久性的</li>
</ul>
</li>
</ul>
<h2 id="【二】事务名词">【二】事务名词</h2>
<ul>
<li>开启事务：Start Transaction</li>
<li>事务结束：End Transaction</li>
<li>提交事务：Commit Transaction</li>
<li>回滚事务：Rollback Transaction</li>
</ul>
<h2 id="【三】默认事务行为">【三】默认事务行为</h2>
<ul>
<li>Django是支持事务操作的，它的默认事务行为是自动提交</li>
<li>具体表现形式为：每次数据库操作(比如调用save()方法)会立即被提交到数据库中</li>
<li>如果你希望把连续的SQL操作包裹在一个事务里，就需要手动开启事务</li>
</ul>
<h2 id="【四】开启事务">【四】开启事务</h2>
<h3 id="【1】开启全局事务">【1】开启全局事务</h3>
<ul>
<li>在settings.py中的数据库中配置</li>
</ul>
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        # 手动创建数据库
        'NAME': "django_two",
        "USER": "root",
        "PASSWORD": "1234567",
        "HOST": "127.0.0.1",
        "PORT": 3306,
        "CHARSET": "utf8mb4",
        # 开启全局事务，绑定的是http请求响应整个过程
        "ATOMIC_REQUESTS": True
    }
}
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 解析</span><br><span class="line">  - 每当有请求过来时，Django会在调用视图方法前开启一个事务。</span><br><span class="line">  - 如果完成了请求处理并正确返回了结果，Django就会提交该事务。</span><br><span class="line">  - 否则，Django会回滚该事务</span><br><span class="line"></span><br><span class="line">### 【2】取消局部的事务</span><br><span class="line"></span><br><span class="line">- 方法就是，在你要取消事务的视图函数上写一个添加一个装饰器</span><br><span class="line">- 首先导入一个方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import transaction</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>@transactionnon_atomic_requests</code>装饰器让某些视图函数方法不受事务的控制</li>
</ul>
```python
@transaction.non_atomic_requests
def longin(request):
    return render(request, "login.html", locals())
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 如有多个数据库，让使用otherdb的视图不受事务控制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">@transaction.non_atomic_requests(using=&quot;otherdb&quot;)</span><br><span class="line">def longin(request):</span><br><span class="line">    return render(request, &quot;login.html&quot;, locals())</span><br></pre></td></tr></table></figure>

<ul>
<li>虽然全局开启事务很简单，但Django并不推荐开启全局事务。</li>
<li>因为一旦将事务跟 HTTP 请求绑定到一起时，每一个请求都会开启事务，当访问量增长到一定的时候会造成很大的性能损耗</li>
<li>推荐使用局部开启事务</li>
</ul>
<h3 id="【3】局部开启事务">【3】局部开启事务</h3>
<ul>
<li>借助一个方法</li>
</ul>
```python
from django.db import transaction
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 给视图函数添加装饰器</span><br><span class="line"></span><br><span class="line">#### （1）在函数头上增加装饰器</span><br><span class="line"></span><br><span class="line">- 第一步：引入Django内部的事务模块</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import transaction</span><br></pre></td></tr></table></figure>

<ul>
<li>第二部：在视图函数上添加装饰器</li>
</ul>
```python
# 添加局部开启事务装饰器
@transaction.non_atomic_requests
def longin(request):
    return render(request, "login.html", locals())
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （2）在类内部的函数头上增加装饰器</span><br><span class="line"></span><br><span class="line">- 第一步：引入模块</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import transaction</span><br></pre></td></tr></table></figure>

<ul>
<li>第二部:添加在类里面的函数头上</li>
</ul>
```python
class UserInfo(View):
    # 添加局部开启事务装饰器
    @transaction.atomic
    def get(self, request):
        ...

    def post(self, request):
        ...
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### （3）自定义事务点---&gt;**Savepoint回滚**</span><br><span class="line"></span><br><span class="line">- 自己设定开启事务的点</span><br><span class="line">- 一旦发生异常或错误，我们使用savepoint_rollback方法让程序回滚到指定的保存点</span><br><span class="line">- 如果没有问题，就使用savepoint_commit方法提交事务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.shortcuts import render</span><br><span class="line">from django.db import transaction</span><br><span class="line"></span><br><span class="line">def longin(request):</span><br><span class="line">    # 开启事务</span><br><span class="line">    with transaction.atomic():</span><br><span class="line">        # 记录事务起点</span><br><span class="line">        sid = transaction.savepoint()</span><br><span class="line">        # 异常捕获</span><br><span class="line">        try:</span><br><span class="line">            #执行你的代码</span><br><span class="line">            ...</span><br><span class="line">        except Exception as e:</span><br><span class="line">            # 进行事务的回滚</span><br><span class="line">            transaction.savepoint_rollback(sid)</span><br><span class="line">        # 没有发生错误就提交事务</span><br><span class="line">        transaction.savepoint_commit(sid)</span><br><span class="line">    return render(request, &quot;login.html&quot;, locals())</span><br></pre></td></tr></table></figure>

<h4 id="4-事务提交后回调函数">(4)事务提交后回调函数</h4>
<ul>
<li>意思就是：当前事务提交后立即执行额外的任务</li>
</ul>
```python
# 例1
from django.db import transaction

def do_something():
  pass  # send a mail, invalidate a cache, fire off a Celery task, etc.


transaction.on_commit(do_something)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;% endraw %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 字段及字段参数的补充</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% raw %&#125;```python</span><br><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line"># 【一】CharField 字符串类型</span><br><span class="line"># max_length 规定字符串的长度</span><br><span class="line"># models.CharField(max_length=25)</span><br><span class="line"></span><br><span class="line"># 【二】IntegerField 整数类型</span><br><span class="line"># 只能放数字类型</span><br><span class="line"># 用数字表示 支付方式 微信 支付宝 花呗 ...</span><br><span class="line"># 用数字代表字符串</span><br><span class="line"># models.IntegerField(choices=((1, &quot;微信&quot;), (2, &quot;支付宝&quot;), (3, &quot;花呗&quot;)))</span><br><span class="line"></span><br><span class="line"># 【三】BooleanField 布尔值类型</span><br><span class="line"># 可以放 0 / 1 也可以放 True / False</span><br><span class="line"># models.BooleanField()</span><br><span class="line"></span><br><span class="line"># 【四】EmailField 邮箱</span><br><span class="line"># 必须符合邮箱格式才能被存进去</span><br><span class="line"># models.EmailField()</span><br><span class="line"></span><br><span class="line"># 【五】TextField 大文本字段</span><br><span class="line"># 大量的文本</span><br><span class="line"># models.TextField()</span><br><span class="line"></span><br><span class="line"># 【六】AutoField 自动生成id</span><br><span class="line"># models.AutoField()</span><br><span class="line"></span><br><span class="line"># 【七】DateTimeField 时间日期</span><br><span class="line"># auto_now 第一次创建的时候的时间</span><br><span class="line"># auto_now_add 以后每次更新的时候的时间</span><br><span class="line"># models.DateTimeField(</span><br><span class="line">#     auto_now=True,</span><br><span class="line">#     auto_now_add=True</span><br><span class="line"># )</span><br><span class="line"># models.DateField()</span><br><span class="line"># models.TimeField()</span><br><span class="line"></span><br><span class="line"># 【8】FileField 文件数据</span><br><span class="line"># models.FileField()</span><br><span class="line"></span><br><span class="line"># 【9】ImageField 图片数据</span><br><span class="line"># models.ImageField()</span><br><span class="line"></span><br><span class="line"># 【10】外键关系字段</span><br><span class="line"># 一对多关系</span><br><span class="line"># models.ForeignKey()</span><br><span class="line"># 一对一关系</span><br><span class="line"># models.OneToOneField()</span><br><span class="line"># 多对多关系</span><br><span class="line"># models.ManyToManyField()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 【二】字段参数</span><br><span class="line"># default 默认值</span><br><span class="line"># null 是否为空</span><br><span class="line"># blank 是否为空 从admin后台插入数据逇时候是否可以为空</span><br><span class="line"># unique 是否唯一</span><br><span class="line"></span><br><span class="line"># 【三】自己看 数据库字段优化 defer / only</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Blog/" rel="tag"># Blog</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/10/15/3.0Django%E4%B8%89%E6%9D%BF%E6%96%A7%EF%BC%8C%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%EF%BC%8Cshortcuts,request%E5%AF%B9%E8%B1%A1/" rel="prev" title="3.0Django三板斧，静态文件，shortcuts,request对象">
      <i class="fa fa-chevron-left"></i> 3.0Django三板斧，静态文件，shortcuts,request对象
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/15/13.0Django%E6%A1%86%E6%9E%B6Form%E7%BB%84%E4%BB%B6%E4%B9%8B%E6%B8%B2%E6%9F%93HTML%E4%BB%A3%E7%A0%81/" rel="next" title="13.0Django框架Form组件之渲染HTML代码">
      13.0Django框架Form组件之渲染HTML代码 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Django框架之模型层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E4%B8%80%E3%80%91%E6%A8%A1%E5%9E%8B%E5%B1%82%E5%BC%95%E5%85%A5%EF%BC%88%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%EF%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">【一】模型层引入（测试环境搭建）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%88%A0"><span class="nav-number">1.1.0.1.</span> <span class="nav-text">（2）删</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%9F%A5"><span class="nav-number">1.1.0.2.</span> <span class="nav-text">（4）查</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">创建出版社表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">创建作者详情表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text">创建作者表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E4%BA%94%E3%80%91%E4%B8%80%E5%AF%B9%E5%A4%9A%E7%9A%84%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5"><span class="nav-number">4.1.</span> <span class="nav-text">【五】一对多的外键字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%901%E3%80%91%E6%B7%BB%E5%8A%A0%E5%80%BC"><span class="nav-number">4.1.1.</span> <span class="nav-text">【1】添加值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%903%E3%80%91%E4%BF%AE%E6%94%B9%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5"><span class="nav-number">4.1.2.</span> <span class="nav-text">【3】修改外键字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%903%E3%80%91%E4%BF%AE%E6%94%B9%E5%A4%96%E9%94%AE%E5%85%B3%E7%B3%BB"><span class="nav-number">4.1.3.</span> <span class="nav-text">【3】修改外键关系</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E4%B8%BB%E9%94%AE%E4%B8%BA1%E7%9A%84%E4%BD%9C%E8%80%85"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">（2）查询数据主键为1的作者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%9F%A5%E8%AF%A2%E5%87%BA%E7%89%88%E7%A4%BE%E6%98%AF-1%E5%87%BA%E7%89%88%E7%A4%BE-%E7%9A%84%E4%B9%A6"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">(4)查询出版社是  1出版社  的书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E6%9F%A5%E8%AF%A2%E6%89%8B%E6%9C%BA%E5%8F%B7%E6%98%AF110%E7%9A%84%E4%BD%9C%E8%80%85%E5%A7%93%E5%90%8D"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">(6)查询手机号是110的作者姓名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%902%E3%80%91%E8%81%94%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.1.4.</span> <span class="nav-text">【2】联表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%9F%A5%E8%AF%A2tom1%E7%9A%84%E6%89%8B%E6%9C%BA%E5%8F%B7%E5%92%8C%E4%BD%9C%E8%80%85%E7%9A%84%E5%90%8D%E5%AD%97"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">（1）查询tom1的手机号和作者的名字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%9F%A5%E8%AF%A2%E4%B9%A6%E7%B1%8D%E4%B8%BB%E9%94%AE%E4%B8%BA1%E7%9A%84%E5%87%BA%E7%89%88%E7%A4%BE%E7%9A%84%E5%90%8D%E5%AD%97%E5%92%8C%E4%B9%A6%E7%9A%84%E5%90%8D%E5%AD%97"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">（2）查询书籍主键为1的出版社的名字和书的名字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%9F%A5%E8%AF%A2%E4%B9%A6%E7%B1%8D%E4%B8%BB%E9%94%AE%E4%B8%BA1%E7%9A%84%E4%BD%9C%E8%80%85%E7%9A%84%E5%90%8D%E5%AD%97"><span class="nav-number">4.1.4.3.</span> <span class="nav-text">(3)查询书籍主键为1的作者的名字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%9F%A5%E8%AF%A2%E4%B9%A6%E7%B1%8D%E4%B8%BB%E9%94%AE%E4%B8%BA1%E7%9A%84%E4%BD%9C%E8%80%85%E7%9A%84%E6%89%8B%E6%9C%BA%E5%8F%B7"><span class="nav-number">4.1.4.4.</span> <span class="nav-text">(4)查询书籍主键为1的作者的手机号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%902%E3%80%91%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%E6%A1%88%E4%BE%8B"><span class="nav-number">4.1.5.</span> <span class="nav-text">【2】聚合函数案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%B8%80%E6%AC%A1%E6%80%A7%E7%94%A8%E5%BE%88%E5%A4%9A%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.5.1.</span> <span class="nav-text">(2)一次性用很多方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%903%E3%80%91%E6%A1%88%E4%BE%8B"><span class="nav-number">4.1.6.</span> <span class="nav-text">【3】案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E7%BB%9F%E8%AE%A1%E6%AF%8F%E4%B8%80%E6%9C%AC%E4%B9%A6%E7%9A%84%E4%BD%9C%E8%80%85%E4%B8%AA%E6%95%B0"><span class="nav-number">4.1.6.1.</span> <span class="nav-text">（1）统计每一本书的作者个数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%BB%9F%E8%AE%A1%E4%B8%8D%E6%AD%A2%E4%B8%80%E4%B8%AA%E4%BD%9C%E8%80%85%E7%9A%84%E5%9B%BE%E4%B9%A6"><span class="nav-number">4.1.6.2.</span> <span class="nav-text">（3）统计不止一个作者的图书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%B0%8F%E7%BB%93"><span class="nav-number">4.1.6.3.</span> <span class="nav-text">(5)小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%902%E3%80%91F%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.1.7.</span> <span class="nav-text">【2】F查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98%E6%95%B0%E5%A4%A7%E4%BA%8E%E9%94%80%E9%87%8F%E7%9A%84%E4%B9%A6%E7%B1%8D"><span class="nav-number">4.1.7.1.</span> <span class="nav-text">（1）查询库存数大于销量的书籍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%B0%86%E6%89%80%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%90%8E%E9%9D%A2%E6%B7%BB%E5%8A%A0-nb"><span class="nav-number">4.1.7.2.</span> <span class="nav-text">(3)将所有的数据后面添加_nb</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%903%E3%80%91Q%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.1.8.</span> <span class="nav-text">【3】Q查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%9F%A5%E8%AF%A2%E5%8D%96%E5%87%BA%E6%95%B0%E5%A4%A7%E4%BA%8E100%E6%88%96%E8%80%85%E4%BB%B7%E6%A0%BC%E5%B0%8F%E4%BA%8E500%E7%9A%84%E4%B9%A6%E7%B1%8D"><span class="nav-number">4.1.8.1.</span> <span class="nav-text">(1)查询卖出数大于100或者价格小于500的书籍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Q%E7%9A%84%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95"><span class="nav-number">4.1.8.2.</span> <span class="nav-text">（2）Q的高阶用法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">5.</span> <span class="nav-text">Django中开启事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E4%B8%80%E3%80%91ACID%E7%89%B9%E6%80%A7"><span class="nav-number">5.1.</span> <span class="nav-text">【一】ACID特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E4%BA%8C%E3%80%91%E4%BA%8B%E5%8A%A1%E5%90%8D%E8%AF%8D"><span class="nav-number">5.2.</span> <span class="nav-text">【二】事务名词</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E4%B8%89%E3%80%91%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1%E8%A1%8C%E4%B8%BA"><span class="nav-number">5.3.</span> <span class="nav-text">【三】默认事务行为</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%90%E5%9B%9B%E3%80%91%E5%BC%80%E5%90%AF%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.4.</span> <span class="nav-text">【四】开启事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%901%E3%80%91%E5%BC%80%E5%90%AF%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.4.1.</span> <span class="nav-text">【1】开启全局事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%903%E3%80%91%E5%B1%80%E9%83%A8%E5%BC%80%E5%90%AF%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.4.2.</span> <span class="nav-text">【3】局部开启事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E5%90%8E%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-number">5.4.2.1.</span> <span class="nav-text">(4)事务提交后回调函数</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Aurora</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要，但是你不努力，选择就只是空谈</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">194</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Aurora</span>
</div>
  <div class="powered-by">由 <a href="https://github.com/lsk-0912" class="theme-link" rel="noopener" target="_blank">lsk-0912</a> & <a href="https://github.com/lsk-0912" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
